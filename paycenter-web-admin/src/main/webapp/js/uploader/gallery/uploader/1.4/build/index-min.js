KISSY.add("gallery/uploader/1.4/base",function(e,j,i,f,b,d,a,c,g,k){function h(a){h.superclass.constructor.call(this,a)}e.mix(h,{type:{AUTO:"auto",IFRAME:"iframe",AJAX:"ajax",FLASH:"flash"},event:{SELECT:"select",ADD:"add",START:"start",PROGRESS:"progress",COMPLETE:"complete",SUCCESS:"success",UPLOAD_FILES:"uploadFiles",CANCEL:"cancel",ERROR:"error",REMOVE:"remove",RESTORE:"restore"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error"}});e.extend(h,
j,{upload:function(a){if(!e.isNumber(a))return!1;var c=this.get("uploadType"),b=this.get("type"),d=this.get("queue"),g=d.get("files")[a],f;if(!e.isPlainObject(g))return e.log("[uploader]:\u961f\u5217\u4e2d\u4e0d\u5b58\u5728id\u4e3a"+a+"\u7684\u6587\u4ef6"),!1;if(""!=this.get("curUploadIndex"))return alert("\u7b2c"+this.get("curUploadIndex")+"\u6587\u4ef6\u6b63\u5728\u4e0a\u4f20\uff0c\u8bf7\u4e0a\u4f20\u5b8c\u540e\u518d\u64cd\u4f5c\uff01"),!1;f=g.input.id||g.input;"ajax"==b&&(f=g.data);if("error"===g.status||!this.get("isAllowUpload"))return!1;this.set("curUploadIndex",a);this.fire(h.event.START,{index:a,file:g});d.fileStatus(a,h.status.START);
c.upload(f)},cancel:function(a){var c=this.get("uploadType"),b=this.get("queue"),d=h.status,g=b.fileStatus(a);e.isNumber(a)&&g!=d.SUCCESS?(c.stop(),b.fileStatus(a,d.CANCEL)):(c.stop(),this._continueUpload());return this},stop:function(){this.set("uploadFilesStatus","");this.cancel();return this},uploadFiles:function(a){e.isString(a)||(a=h.status.WAITING);this.set("uploadFilesStatus",a);this._uploaderStatusFile(a);return this},_uploaderStatusFile:function(a){a=this.get("queue").getIndexs(a);if(!a.length)return this.set("uploadFilesStatus",
""),this.fire(h.event.UPLOAD_FILES),!1;this.upload(a[0]);return this},isSupportAjax:function(){var a=!1;try{FormData&&(a=!0)}catch(c){a=!1}return a},isSupportFlash:function(){var a=e.UA.fpv();return e.isArray(a)&&0<a.length},_renderUploaderCore:function(a){var c=this;c.get("type");if(!a)return!1;var b={action:c.get("action"),data:c.get("data"),dataType:"json"},d=c.get("button");c.get("type")==h.type.FLASH&&e.mix(b,{swfUploader:d.get("swfUploader")});b.fileDataName=c.get("name");b.CORS=c.get("CORS");
b=new a(b);a=a.event;b.on(a.SUCCESS,c._uploadCompleteHanlder,c);b.on(a.ERROR,function(a){c.fire(event.ERROR,{status:a.status,result:a.result});c._continueUpload()},c);if(a.PROGRESS)b.on(a.PROGRESS,c._uploadProgressHandler,c);b.on(a.STOP,c._uploadStopHanlder,c);c.set("uploadType",b);return b},getUploadType:function(a){var c=this,b=h.type,d;a==b.AUTO&&(a=[b.AJAX,b.IFRAME]);e.isArray(a)&&0<a.length?e.each(a,function(a){if(d=c._getType(a))return!1}):d=c._getType(a);return d},_getType:function(c){var g=
h.type,f=this.isSupportAjax(),k=this.isSupportFlash();switch(c){case g.IFRAME:g=b;break;case g.AJAX:g=f&&d||!1;break;case g.FLASH:g=k&&a||!1;break;default:return e.log("[uploader]:type\u53c2\u6570\u4e0d\u5408\u6cd5"),!1}g&&e.log("[uploader]:\u4f7f\u7528"+c+"\u4e0a\u4f20\u65b9\u5f0f");this.set("type",c);return g},_renderButton:function(){var a,b,d=this.get("type");a=this.get("target");b=this.get("multiple");var k=this.get("disabled"),k={name:this.get("name"),multiple:b,disabled:k};d==h.type.FLASH?(b=g,e.mix(k,{size:this.get("swfSize")})):b=c;a=new b(a,
k);a.on("change",this._select,this);a.render();this.set("button",a);d==h.type.IFRAME&&10>f.ie&&this.set("multiple",!1);return a},_renderQueue:function(){var a=this,c=new k;c.set("uploader",a);c.on("add",function(c){a.fire(h.event.ADD,c)});c.on("remove",function(c){a.fire(h.event.REMOVE,c)});a.set("queue",c);return c},_select:function(a){var c=this,b=c.get("autoUpload"),d=c.get("queue"),g=c.get("curUploadIndex"),f=a.files;e.each(f,function(c){c.size||(c.size=0);c.name||(c.name=c.fileName||"");c.input=
a.input||c});f=c._processExceedMultiple(f);c.fire(h.event.SELECT,{files:f});if(!c.get("isAllowUpload"))return!1;d.add(f,function(){""==g&&b&&c.uploadFiles()})},_processExceedMultiple:function(a){var c=this.get("multipleLen");return 0>c||!e.isArray(a)||!a.length?a:e.filter(a,function(a,b){return b<c})},_uploadCompleteHanlder:function(a){var a=a.result,c,b=h.event,d=this.get("queue"),g=this.get("curUploadIndex");if(!e.isObject(a))return!1;d.updateFile(g,{result:a});c=Number(a.status);1===c?(d.fileStatus(g,
h.status.SUCCESS),this._success(a.data),this.fire(b.SUCCESS,{index:g,file:d.getFile(g),result:a})):(d.fileStatus(g,h.status.ERROR,{msg:a.msg||a.message||"",result:a}),this.fire(b.ERROR,{status:c,result:a,index:g,file:d.getFile(g)}));this.set("curUploadIndex","");this.fire(b.COMPLETE,{index:g,file:d.getFile(g),result:a});this._continueUpload()},_uploadStopHanlder:function(){var a=this.get("queue"),c=this.get("curUploadIndex");a.fileStatus(c,h.status.CANCEL);this.set("curUploadIndex","");this.fire(h.event.CANCEL,
{index:c})},_continueUpload:function(){var a=this.get("uploadFilesStatus");""!=a&&this._uploaderStatusFile(a)},_uploadProgressHandler:function(a){var c=this.get("queue"),b=this.get("curUploadIndex"),d=c.getFile(b);e.mix(a,{file:d});c.fileStatus(b,h.status.PROGRESS,a);this.fire(h.event.PROGRESS,a)},_success:function(a){if(!e.isObject(a))return!1;var a=a.url,c=this.get("curUploadIndex"),b=this.get("queue");if(!e.isString(a))return!1;b.updateFile(c,{sUrl:a})}},{ATTRS:{button:{value:{}},queue:{value:{}},
curUploadIndex:{value:""},uploadType:{value:{}},urlsInput:{value:""},uploadFilesStatus:{value:""},swfSize:{value:{}},CORS:{value:!1}}});return h},{requires:"base,node,ua,./type/iframe,./type/ajax,./type/flash,./button/base,./button/swfButton,./queue".split(",")});
KISSY.add("gallery/uploader/1.4/button/base",function(e,j,i){function f(d,a){a=e.merge({target:b(d)},a);f.superclass.constructor.call(this,a)}var b=j.all;return e.mix(f,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"},getFileName:function(b){return b.replace(/.*(\/|\\)/,"")}}),e.extend(f,i,{render:function(){var b=this.get("target");return!1===this.fire(f.event.beforeRender)?(e.log("[Uploader-Button] button render was prevented."),
!1):null==b?(e.log("[Uploader-Button] Cannot find target!"),!1):(this._createInput(),this.fire(f.event.afterRender),this)},show:function(){return this.get("target").show(),this.fire(f.event.afterShow),f},hide:function(){return this.get("target").hide(),this.fire(f.event.afterHide),f},reset:function(){var d=this.get("inputContainer");return b(d).remove(),this.set("inputContainer",""),this.set("fileInput",""),this._createInput(),this},_createInput:function(){var d,a,c,g=this.get("target"),f=this.get("name"),
h=this.get("tpl");return e.isString(f)&&e.isString(h)?(d=e.substitute(h,{name:f}),a=b(d),b(a).appendTo(g),c=b(a).children("input"),6==e.UA.ie&&c.css("fontSize","400px"),b(c).on("change",this._changeHandler,this),this.set("fileInput",c),this.set("inputContainer",a),this._setDisabled(this.get("disabled")),this._setMultiple(this.get("multiple")),a):(e.log("[Uploader-Button] No name or tpl specified."),!1)},_changeHandler:function(d){var a=this.get("fileInput"),c=b(a).val(),d=d.target.files,g=[];return""==
c?(e.log("[Uploader-Button] No file selected."),!1):(d?e.each(d,function(a){e.isObject(a)&&g.push({name:a.name,type:a.type,size:a.size,data:a})}):g.push({name:f.getFileName(c)}),this.fire(f.event.CHANGE,{files:g,input:a.getDOMNode()}),this.reset(),void 0)},_setDisabled:function(d){var a=this.get("cls").disabled,c=this.get("target"),g=this.get("fileInput");return c.length&&e.isBoolean(d)?(d?(c.addClass(a),b(g).hide()):(c.removeClass(a),b(g).show()),d):!1},_setMultiple:function(b){var a=this.get("fileInput");
return a.length?(b&&a.attr("multiple","multiple")||a.removeAttr("multiple"),b):!1}},{ATTRS:{target:{value:null},fileInput:{value:""},inputContainer:{value:""},tpl:{value:'<div class="file-input-wrapper" style="overflow: hidden;"><input type="file" name="{name}" hidefocus="true" class="file-input" /></div>'},name:{value:"fileInput",setter:function(d){return this.get("fileInput")&&b(this.get("fileInput")).attr("name",d),d}},disabled:{value:!1,setter:function(b){return this._setDisabled(b),b}},multiple:{value:!0,
setter:function(b){return this._setMultiple(b),b}},cls:{value:{disabled:"uploader-button-disabled"}}}}),f},{requires:["node","base"]});
KISSY.add("gallery/uploader/1.4/button/base",function(e,j,i){function f(d,a){a=e.merge({target:b(d)},a);f.superclass.constructor.call(this,a)}var b=j.all;e.mix(f,{event:{beforeShow:"beforeShow",afterShow:"afterShow",beforeHide:"beforeHide",afterHide:"afterHide",beforeRender:"beforeRender",afterRender:"afterRender",CHANGE:"change"},getFileName:function(b){return b.replace(/.*(\/|\\)/,"")}});e.extend(f,i,{render:function(){var b=this.get("target");if(!1===this.fire(f.event.beforeRender))return e.log("[Uploader-Button] button render was prevented."),
!1;if(null==b)return e.log("[Uploader-Button] Cannot find target!"),!1;this._createInput();this.fire(f.event.afterRender);return this},show:function(){this.get("target").show();this.fire(f.event.afterShow);return f},hide:function(){this.get("target").hide();this.fire(f.event.afterHide);return f},reset:function(){var d=this.get("inputContainer");b(d).remove();this.set("inputContainer","");this.set("fileInput","");this._createInput();return this},_createInput:function(){var d=this.get("target"),a=this.get("name"),
c=this.get("tpl");if(!e.isString(a)||!e.isString(c))return e.log("[Uploader-Button] No name or tpl specified."),!1;a=e.substitute(c,{name:a});a=b(a);b(a).appendTo(d);d=b(a).children("input");6==e.UA.ie&&d.css("fontSize","400px");b(d).on("change",this._changeHandler,this);this.set("fileInput",d);this.set("inputContainer",a);this._setDisabled(this.get("disabled"));this._setMultiple(this.get("multiple"));return a},_changeHandler:function(d){var a=this.get("fileInput"),c=b(a).val(),d=d.target.files,g=
[];if(""==c)return e.log("[Uploader-Button] No file selected."),!1;d?e.each(d,function(a){e.isObject(a)&&g.push({name:a.name,type:a.type,size:a.size,data:a})}):g.push({name:f.getFileName(c)});this.fire(f.event.CHANGE,{files:g,input:a.getDOMNode()});this.reset()},_setDisabled:function(d){var a=this.get("cls").disabled,c=this.get("target"),g=this.get("fileInput");if(!c.length||!e.isBoolean(d))return!1;d?(c.addClass(a),b(g).hide()):(c.removeClass(a),b(g).show());return d},_setMultiple:function(b){var a=
this.get("fileInput");if(!a.length)return!1;b&&a.attr("multiple","multiple")||a.removeAttr("multiple");return b}},{ATTRS:{target:{value:null},fileInput:{value:""},inputContainer:{value:""},tpl:{value:'<div class="file-input-wrapper" style="overflow: hidden;"><input type="file" name="{name}" hidefocus="true" class="file-input" /></div>'},name:{value:"fileInput",setter:function(d){this.get("fileInput")&&b(this.get("fileInput")).attr("name",d);return d}},disabled:{value:!1,setter:function(b){this._setDisabled(b);
return b}},multiple:{value:!0,setter:function(b){this._setMultiple(b);return b}},cls:{value:{disabled:"uploader-button-disabled"}}}});return f},{requires:["node","base"]});
KISSY.add("gallery/uploader/1.4/button/swfButton",function(e,j,i,f){function b(a,c){c=e.merge({target:d(a)},c);b.superclass.constructor.call(this,c)}var d=j.all;return e.mix(b,{event:{RENDER:"render",CHANGE:"change",MOUSE_OVER:"mouseOver",MOUSE_DOWN:"mouseDown",MOUSE_UP:"mouseUp",MOUSE_OUT:"mouseOut",CLICK:"click"}}),e.extend(b,i,{render:function(){var a,c=this,e=c.get("target"),d=c.get("multiple"),f=c.get("fileFilters");e.css("position","relative");c.set("swfWrapper",c._createSwfWrapper());c._setFlashSizeConfig();
a=c._initSwfUploader();a.on("contentReady",function(){a.isContent||(a.isContent=!0,a.browse(d,f),c._bindBtnEvent(),a.on("fileSelect",c._changeHandler,c),c._setDisabled(c.get("disabled")),c.fire(b.event.RENDER))},c)},_createSwfWrapper:function(){var a=this.get("target"),c=this.get("tpl"),b=""!=this.get("swfWrapperId")&&this.get("swfWrapperId")||"swf-uploader-wrapper-"+e.guid(),c=e.substitute(c,{id:b});return this.set("swfWrapperId",b),d(c).appendTo(a)},_initSwfUploader:function(){var a,c=this.get("flash"),
b=this.get("swfWrapperId");e.mix(c,{id:"swfUploader"+e.guid()});try{a=new f(b,c),this.set("swfUploader",a)}catch(d){}return a},_bindBtnEvent:function(){var a=this,c=b.event,d=a.get("swfUploader");return d?(e.each(c,function(c){d.on(c,function(){a.fire(c)},a)}),a):!1},_setFlashSizeConfig:function(){var a=this.get("flash"),c=this.get("target"),b=this.get("size");e.isEmptyObject(b)?e.mix(a.attrs,{width:c.innerWidth(),height:c.innerHeight()}):e.mix(a.attrs,b);this.set("flash",a)},_changeHandler:function(a){this.get("swfUploader").id==
a.id&&this.fire(b.event.CHANGE,{files:a.fileList})},_setDisabled:function(a){var c=this.get("swfUploader"),b=this.get("cls").disabled,d=this.get("target"),f=this.get("swfWrapper");return c&&e.isBoolean(a)?(a?(d.addClass(b),f.css("top","-3000px")):(d.removeClass(b),f.css("top",0)),a):!1},show:function(){this.get("target").show()},hide:function(){this.get("target").hide()}},{ATTRS:{target:{value:""},swfWrapper:{value:""},swfWrapperId:{value:""},tpl:{value:'<div id="{id}" class="uploader-button-swf" style="position: absolute;top:0;left:0;z-index:2000;"></div>'},
multiple:{value:!0,setter:function(a){var c=this.get("swfUploader");return c&&c.multifile(a),a}},fileFilters:{value:[],setter:function(a){var c=this.get("swfUploader");return e.isObject(a)&&(a=[a]),c&&e.isArray(a)&&e.later(function(){c.filter(a)},800),a}},disabled:{value:!1,setter:function(a){return this.get("swfUploader")&&this._setDisabled(a),a}},cls:{value:{disabled:"uploader-button-disabled"}},size:{value:{}},flash:{value:{src:"http://a.tbcdn.cn/s/kissy/gallery/uploader/1.4/plugins/ajbridge/uploader.swf",
id:"swfUploader",params:{bgcolor:"#fff",wmode:"transparent"},attrs:{},hand:!0,btn:!0}},swfUploader:{value:""}}}),b},{requires:["node","base","../plugins/ajbridge/uploader"]});
KISSY.add("gallery/uploader/1.4/button/swfButton",function(e,j,i,f){function b(a,c){c=e.merge({target:d(a)},c);b.superclass.constructor.call(this,c)}var d=j.all;e.mix(b,{event:{RENDER:"render",CHANGE:"change",MOUSE_OVER:"mouseOver",MOUSE_DOWN:"mouseDown",MOUSE_UP:"mouseUp",MOUSE_OUT:"mouseOut",CLICK:"click"}});e.extend(b,i,{render:function(){var a=this,c=a.get("target"),d,e=a.get("multiple"),f=a.get("fileFilters");c.css("position","relative");a.set("swfWrapper",a._createSwfWrapper());a._setFlashSizeConfig();
d=a._initSwfUploader();d.on("contentReady",function(){d.isContent||(d.isContent=!0,d.browse(e,f),a._bindBtnEvent(),d.on("fileSelect",a._changeHandler,a),a._setDisabled(a.get("disabled")),a.fire(b.event.RENDER))},a)},_createSwfWrapper:function(){var a=this.get("target"),c=this.get("tpl"),b=""!=this.get("swfWrapperId")&&this.get("swfWrapperId")||"swf-uploader-wrapper-"+e.guid(),c=e.substitute(c,{id:b});this.set("swfWrapperId",b);return d(c).appendTo(a)},_initSwfUploader:function(){var a=this.get("flash"),
c=this.get("swfWrapperId"),b;e.mix(a,{id:"swfUploader"+e.guid()});try{b=new f(c,a),this.set("swfUploader",b)}catch(d){}return b},_bindBtnEvent:function(){var a=this,c=b.event,d=a.get("swfUploader");if(!d)return!1;e.each(c,function(c){d.on(c,function(){a.fire(c)},a)});return a},_setFlashSizeConfig:function(){var a=this.get("flash"),c=this.get("target"),b=this.get("size");e.isEmptyObject(b)?e.mix(a.attrs,{width:c.innerWidth(),height:c.innerHeight()}):e.mix(a.attrs,b);this.set("flash",a)},_changeHandler:function(a){this.get("swfUploader").id==
a.id&&this.fire(b.event.CHANGE,{files:a.fileList})},_setDisabled:function(a){var c=this.get("swfUploader"),b=this.get("cls").disabled,d=this.get("target"),f=this.get("swfWrapper");if(!c||!e.isBoolean(a))return!1;a?(d.addClass(b),f.css("top","-3000px")):(d.removeClass(b),f.css("top",0));return a},show:function(){this.get("target").show()},hide:function(){this.get("target").hide()}},{ATTRS:{target:{value:""},swfWrapper:{value:""},swfWrapperId:{value:""},tpl:{value:'<div id="{id}" class="uploader-button-swf" style="position: absolute;top:0;left:0;z-index:2000;"></div>'},
multiple:{value:!0,setter:function(a){var c=this.get("swfUploader");c&&c.multifile(a);return a}},fileFilters:{value:[],setter:function(a){var c=this.get("swfUploader");e.isObject(a)&&(a=[a]);c&&e.isArray(a)&&e.later(function(){c.filter(a)},800);return a}},disabled:{value:!1,setter:function(a){this.get("swfUploader")&&this._setDisabled(a);return a}},cls:{value:{disabled:"uploader-button-disabled"}},size:{value:{}},flash:{value:{src:"http://a.tbcdn.cn/s/kissy/gallery/uploader/1.4/plugins/ajbridge/uploader.swf",
id:"swfUploader",params:{bgcolor:"#fff",wmode:"transparent"},attrs:{},hand:!0,btn:!0}},swfUploader:{value:""}}});return b},{requires:["node","base","../plugins/ajbridge/uploader"]});
KISSY.add("gallery/uploader/1.4/index",function(e,j,i,f,b){var d=j.all,a=f.extend([i],{constructor:function(c,b){a.superclass.constructor.call(this,b);this.set("target",c);this._init()},_init:function(){if(!this.get("target").length)return e.log("\u76ee\u6807\u5143\u7d20\u4e0d\u5b58\u5728\uff01"),!1;var a=this.getUploadType(this.get("type"));this._replaceBtn();this._renderButton();this._renderQueue();this._renderUploaderCore(a);return this},_replaceBtn:function(){var a=this.get("target");if(!a.length)return!1;var b=a[0].defaultValue||"\u4e0a\u4f20\u6587\u4ef6",
b=e.substitute(this.get("btnTpl"),{text:b}),b=d(b).insertAfter(a);!this.get("name")&&a.attr("name")&&this.set("name",a.attr("name"));this.set("_oldInput",a.clone());a.remove();this.set("target",b);return b},theme:function(a){var b=this.get("theme");if(!a)return!1;if(b)return e.log("\u4e0d\u652f\u6301\u91cd\u65b0\u6e32\u67d3\u4e3b\u9898\uff01"),this;a.set("uploader",this);a.set("queue",this.get("queue"));a.render&&a.render();this.fire("themeRender",{theme:b,uploader:this});this.set("theme",a);return this},restore:function(a){var f=this,k;f.set("hasRestore",
!0);if(a){a=d(a);if(!a.length)return e.log("restore()\uff1a\u4e0d\u5b58\u5728target\uff01"),!1;k=a.text()}else{a=f.get("theme");if(!a)return!1;a=a.get("queueTarget");if(!a||!a.length)return!1;a.all("script").each(function(a){"text/uploader-files"==a.attr("type")&&(k=a.html())})}k=b.parse(k);if(!k.length)return!1;var h=f.get("queue"),i;e.each(k,function(a){a.status=1;i={type:"restore",name:a.name||"",url:a.url||"",result:a};var a=h.add(i),b=a.id,c=h.getFileIndex(b);h.fileStatus(c,"success",{index:c,id:b,file:a});f.fire("success",
{file:a,result:a.result})})}},{ATTRS:{target:{value:"",getter:function(a){return d(a)}},fileInput:{value:"",getter:function(){return this.get("target").all(".file-input")}},theme:{value:""},btnTpl:{value:'<a href="javascript:void(0)" class="g-u ks-uploader-button"><span class="btn-text">{text}</span></a>'},button:{value:{}},queue:{value:{}},type:{value:"auto"},multiple:{value:!1,setter:function(a){var b=this.get("button");!e.isEmptyObject(b)&&e.isBoolean(a)&&b.set("multiple",a);return a}},multipleLen:{value:-1},
disabled:{value:!1,setter:function(a){var b=this.get("button");!e.isEmptyObject(b)&&e.isBoolean(a)&&b.set("disabled",a);return a}},action:{value:"",setter:function(a){var b=this.get("uploadType");b&&b.set("action",a);return a}},data:{value:{},setter:function(a){if(e.isObject(a)){var b=this.get("uploadType");b&&b.set("data",a)}return a}},isAllowUpload:{value:!0},autoUpload:{value:!0},filter:{value:"",setter:function(a){var b=this.get("uploadType");b&&b.set("filter",a);return a}},curUploadIndex:{value:""},
uploadType:{value:""},swfSize:{value:{}},hasRestore:{value:!1}}},"Uploader");return a},{requires:["node","./base","rich-base","json"]});
KISSY.add("gallery/uploader/1.4/queue",function(e,j,i){function f(b){f.superclass.constructor.call(this,b)}e.mix(f,{event:{ADD:"add",ADD_FILES:"addFiles",REMOVE:"remove",CLEAR:"clear",FILE_STATUS:"statusChange",UPDATE_FILE:"updateFile"},status:{WAITING:"waiting",START:"start",PROGRESS:"progress",SUCCESS:"success",CANCEL:"cancel",ERROR:"error",RESTORE:"restore"},FILE_ID_PREFIX:"file-"});e.extend(f,i,{add:function(b,d){var a=this,c={};if(0<b.length){var c=[],f=a.get("uploader"),k=a.get("files").length,
h=0<f.get("max");e.each(b,function(b,d){h?f.get("max")>=k+d+1&&c.push(a._addFile(b)):c.push(a._addFile(b))})}else c=a._addFile(b);d&&d.call(a);return c},_addFile:function(b,d){if(!e.isObject(b))return e.log("[uploader-queue]:_addFile()\u53c2\u6570file\u4e0d\u5408\u6cd5\uff01"),!1;var a=this._setAddFileData(b),c=this.getFileIndex(a.id),g=this.get("fnAdd");e.isFunction(g)&&(a=g(c,a));this.fire(f.event.ADD,{index:c,file:a,uploader:this.get("uploader")});d&&d.call(this,c,a);return a},remove:function(b,d){var a=this.get("files"),c;
e.isString(b)&&(b=this.getFileIndex(b));c=a[b];if(!e.isObject(c))return e.log("[uploader-queue]:remove()\u4e0d\u5b58\u5728index\u4e3a"+b+"\u7684\u6587\u4ef6\u6570\u636e"),!1;a=e.filter(a,function(a,c){return c!==b});this.set("files",a);this.fire(f.event.REMOVE,{index:b,file:c});d&&d.call(this,b,c);return c},clear:function(){function b(){a=d.get("files");if(!a.length)return d.fire(f.event.CLEAR),!1;d.remove(0,function(){b()})}var d=this,a;b()},fileStatus:function(b,d,a){if(!e.isNumber(b))return!1;var c=this.getFile(b);this.get("theme");var g;
if(!c)return!1;g=c.status;if(!d)return g;if(g==d)return this;this.updateFile(b,{status:d});this.fire(f.event.FILE_STATUS,{index:b,status:d,args:a,file:c});return this},getFile:function(b){if(!e.isNumber(b))return!1;b=this.get("files")[b];e.isPlainObject(b)||(b={});return b},getFileIndex:function(b){var d=this.get("files"),a=-1;e.each(d,function(c,d){if(c.id==b)return a=d,!0});return a},updateFile:function(b,d){if(!e.isNumber(b))return!1;if(!e.isObject(d))return e.log("[uploader-queue]:updateFile()\u7684data\u53c2\u6570\u6709\u8bef\uff01"),
!1;var a=this.get("files"),c=this.getFile(b);if(!c)return!1;e.mix(c,d);a[b]=c;this.set("files",a);this.fire(f.event.UPDATE_FILE,{index:b,file:c});return c},getIndexs:function(b){var d=this.get("files"),a,c=[];if(!d.length)return c;e.each(d,function(d,f){e.isObject(d)&&(a=d.status,a==b&&c.push(f))});return c},getFiles:function(b){var d=this.get("files"),a=[];if(!d.length)return[];e.each(d,function(c){c&&c.status==b&&a.push(c)});return a},_setAddFileData:function(b){var d=this.get("files");if(!e.isObject(b))return e.log("[uploader-queue]:_updateFileData()\u53c2\u6570file\u4e0d\u5408\u6cd5\uff01"),
!1;b.id||(b.id=e.guid(f.FILE_ID_PREFIX));if(b.size){var a;a=b.size;var c=-1;do a/=1024,c++;while(99<a);a=Math.max(a,0.1).toFixed(1)+"kB,MB,GB,TB,PB,EB".split(",")[c];b.textSize=a}b.status="waiting";d.push(b);return b}},{ATTRS:{fnAdd:{value:""},files:{value:[]},uploader:{value:""}}});return f},{requires:["node","base"]});
KISSY.add("gallery/uploader/1.4/type/ajax",function(e,j,i){function f(b){f.superclass.constructor.call(this,b)}e.mix(f,{event:e.merge(i.event,{PROGRESS:"progress"})});e.extend(f,i,{upload:function(b){if(!b)return e.log("[uploader-AjaxType]:upload()\uff0cfileData\u53c2\u6570\u6709\u8bef\uff01"),!1;this._setFormData();this._addFileData(b);this.send();return this},stop:function(){var b=this.get("xhr");if(!e.isObject(b))return e.log("[uploader-AjaxType]:stop()\uff0cio\u503c\u9519\u8bef\uff01"),!1;b.abort();this.fire(f.event.STOP);return this},send:function(){var b=
this,d=b.get("action"),a=b.get("formData"),c=new XMLHttpRequest;if(b.get("CORS"))try{c.withCredentials=!0}catch(g){e.log("\u4e0d\u652f\u6301withCredentials\u7684\u8bbe\u7f6e\uff01")}c.upload.addEventListener("progress",function(a){b.fire(f.event.PROGRESS,{loaded:a.loaded,total:a.total})});c.onload=function(){var a=b._processResponse(c.responseText);b.fire(f.event.SUCCESS,{result:a})};c.open("POST",d,!0);a.append("type","ajax");c.send(a);b._setFormData();b.set("xhr",c);return b},_setFormData:function(){try{this.set("formData",new FormData),
this._processData()}catch(b){e.log("[uploader-AjaxType]:something error when reset FormData."),e.log(b,"dir")}},_processData:function(){var b=this.get("data"),d=this.get("formData");e.each(b,function(a,b){d.append(b,a)});this.set("formData",d)},_addFileData:function(b){if(!e.isObject(b))return e.log("[uploader-AjaxType]:_addFileData()\uff0cfile\u53c2\u6570\u6709\u8bef\uff01"),!1;var d=this.get("formData"),a=this.get("fileDataName");d.append(a,b);this.set("formData",d)}},{ATTRS:{formData:{value:""},ajaxConfig:{value:{type:"post",
processData:!1,cache:!1,dataType:"json",contentType:!1,xhrFields:{withCredentials:!0}}},xhr:{value:""},fileDataName:{value:""},form:{value:{}},fileInput:{value:""},CORS:{value:!1}}});return f},{requires:["node","./base"]});
KISSY.add("gallery/uploader/1.4/type/base",function(e,j,i){function f(b){f.superclass.constructor.call(this,b)}e.mix(f,{event:{START:"start",STOP:"stop",SUCCESS:"success",ERROR:"error"}});e.extend(f,i,{upload:function(){},stop:function(){},_processResponse:function(b){var d=this.get("filter"),a={};""!=d&&(b=d.call(this,b));if(e.isString(b))try{a=e.JSON.parse(b),a=this._fromUnicode(a)}catch(c){b+="\uff0c\u8fd4\u56de\u7ed3\u679c\u96c6responseText\u683c\u5f0f\u4e0d\u5408\u6cd5\uff01",e.log(b),this.fire("error",{status:-1,result:{msg:b}})}else e.isObject(b)&&
(a=this._fromUnicode(b));e.log("\u670d\u52a1\u5668\u7aef\u8f93\u51fa\uff1a"+e.JSON.stringify(a));return a},_fromUnicode:function(b){function d(a){e.each(a,function(b,f){e.isObject(a[f])?d(a[f]):a[f]=e.isString(b)&&e.fromUnicode(b)||b})}if(!e.isObject(b))return b;d(b);return b}},{ATTRS:{action:{value:""},data:{value:{}},filter:{value:""},CORS:{value:!1}}});return f},{requires:["node","base"]});
KISSY.add("gallery/uploader/1.4/type/flash",function(e,j,i){function f(b){f.superclass.constructor.call(this,b);this.isHasCrossdomain();this._init()}e.mix(f,{event:e.merge(i.event,{SWF_READY:"swfReady",PROGRESS:"progress"})});e.extend(f,i,{_init:function(){var b=this,d=b.get("swfUploader");if(!d)return e.log("[uploader-FlashType]:swfUploader\u5bf9\u8c61\u4e3a\u7a7a\uff01"),!1;d.on("contentReady",function(){b.fire(f.event.SWF_READY)},b);d.on("uploadStart",b._uploadStartHandler,b);d.on("uploadProgress",b._uploadProgressHandler,
b);d.on("uploadCompleteData",b._uploadCompleteDataHandler,b);d.on("uploadError",b._uploadErrorHandler,b)},upload:function(b){var d=this.get("swfUploader"),a=this.get("action"),c=this.get("data"),f=this.get("fileDataName");f||(f="Filedata");this.set("uploadingId",b);e.mix(c,{type:"flash"});d.upload(b,a,"POST",c,f);return this},stop:function(){var b=this.get("swfUploader"),d=this.get("uploadingId");""!=d&&(b.cancel(d),this.fire(f.event.STOP,{id:d}));return this},_uploadStartHandler:function(b){this.fire(f.event.START,
{file:b.file})},_uploadProgressHandler:function(b){e.mix(b,{loaded:b.bytesLoaded,total:b.bytesTotal});e.log("[uploader-FlashType]:\u5df2\u7ecf\u4e0a\u4f20\u5b57\u8282\u6570\u4e3a\uff1a"+b.bytesLoaded);this.fire(f.event.PROGRESS,{loaded:b.loaded,total:b.total})},_uploadCompleteDataHandler:function(b){b=this._processResponse(b.data);this.set("uploadingId","");this.fire(f.event.SUCCESS,{result:b})},_uploadErrorHandler:function(b){this.set("uploadingId","");this.fire(f.event.ERROR,{msg:b.msg})},isHasCrossdomain:function(){e.io({url:"http://"+location.hostname+
"/crossdomain.xml",dataType:"xml",error:function(){e.log("\u7f3a\u5c11crossdomain.xml\u6587\u4ef6\u6216\u8be5\u6587\u4ef6\u4e0d\u5408\u6cd5\uff01")}})}},{ATTRS:{action:{value:"",getter:function(b){if(!/^http/.test(b))var d=location.href.split("/"),b=e.filter(d,function(a,b){return b<d.length-1}).join("/")+"/"+b;return b}},swfUploader:{value:""},uploadingId:{value:""}}});return f},{requires:["node","./base"]});
KISSY.add("gallery/uploader/1.4/type/iframe",function(e,j,i){function f(b){f.superclass.constructor.call(this,b)}var b=j.all;e.mix(f,{tpl:{IFRAME:'<iframe src="javascript:false;" name="{id}" id="{id}" border="no" width="1" height="1" style="display: none;" />',FORM:'<form method="post" enctype="multipart/form-data" action="{action}" target="{target}" style="visibility: hidden;">{hiddenInputs}</form>',HIDDEN_INPUT:'<input type="hidden" name="{name}" value="{value}" />'},event:e.mix(i.event,{CREATE:"create",
REMOVE:"remove"})});e.extend(f,i,{upload:function(d){d=b(d);if(!d.length)return!1;this.fire(f.event.START,{input:d});this.set("fileInput",d);this._create();d=this.get("form");if(!d)return e.log("[uploader-iframeType]:form\u8282\u70b9\u4e0d\u5b58\u5728\uff01"),!1;d.getDOMNode().submit()},stop:function(){this.get("iframe").attr("src",'javascript:"<html></html>";');this._remove();this.fire(f.event.STOP);this.fire(f.event.ERROR,{status:"abort",msg:"\u4e0a\u4f20\u5931\u8d25\uff0c\u539f\u56e0\uff1aabort"});return this},dataToHidden:function(b){if(!e.isObject(b)||e.isEmptyObject(b))return"";
var a="",c=this.get("tpl").HIDDEN_INPUT;if(!e.isString(c))return"";for(var f in b)a+=e.substitute(c,{name:f,value:b[f]});return a},_createIframe:function(){var d="ks-uploader-iframe-"+e.guid(),a=this.get("tpl"),c=a.IFRAME,f=this.get("iframe");if(!e.isEmptyObject(f))return f;if(!e.isString(c))return e.log("[uploader-iframeType]:iframe\u7684\u6a21\u677f\u4e0d\u5408\u6cd5\uff01"),!1;if(!e.isString(d))return e.log("[uploader-iframeType]:id\u5fc5\u987b\u5b58\u5728\u4e14\u4e3a\u5b57\u7b26\u4e32\u7c7b\u578b\uff01"),!1;a=e.substitute(a.IFRAME,{id:d});a=b(a);a.on("load",this._iframeLoadHandler,this);
b("body").append(a);this.set("id",d);this.set("iframe",a);return a},_iframeLoadHandler:function(b){var a=b.target,b=f.event.ERROR,a=a.contentDocument||window.frames[a.id].document;if(!a||!a.body)return this.fire(b,{msg:"\u670d\u52a1\u5668\u7aef\u8fd4\u56de\u6570\u636e\u6709\u95ee\u9898\uff01"}),!1;b=a.body.innerHTML;if(""==b)return!1;b=this._processResponse(b);this.fire(f.event.SUCCESS,{result:b});this._remove()},_createForm:function(){var d=this.get("id"),a=this.get("tpl").FORM,c=this.get("data"),f=this.get("action"),i=this.get("fileInput");if(!e.isString(a))return e.log("[uploader-iframeType]:form\u6a21\u677f\u4e0d\u5408\u6cd5\uff01"),
!1;if(!e.isString(f))return e.log("[uploader-iframeType]:action\u53c2\u6570\u4e0d\u5408\u6cd5\uff01"),!1;c=this.dataToHidden(c);c+=this.dataToHidden({type:"iframe"});d=e.substitute(a,{action:f,target:d,hiddenInputs:c});i=b(d).append(i);b("body").append(i);this.set("form",i);return i},_create:function(){var b=this._createIframe(),a=this._createForm();this.fire(f.event.CREATE,{iframe:b,form:a})},_remove:function(){var b=this.get("form");if(!b)return!1;b.remove();this.reset("form");this.fire(f.event.REMOVE,{form:b})}},{ATTRS:{tpl:{value:f.tpl},
id:{value:"ks-uploader-iframe-"+e.guid()},iframe:{value:{}},form:{value:""},fileInput:{value:""}}});return f},{requires:["node","./base"]});
